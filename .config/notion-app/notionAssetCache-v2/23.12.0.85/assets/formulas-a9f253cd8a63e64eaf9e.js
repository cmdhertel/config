"use strict";(self.webpackChunknotion_next=self.webpackChunknotion_next||[]).push([[9447],{50787:(e,t,n)=>{n.r(t),n.d(t,{addTypesToFormulaAST:()=>Ke,analyzeFormula:()=>ut,convertCollectionFormulaToFormula2:()=>pt,convertFormulaCSTToAST:()=>ge,evaluateFormulaAST:()=>Ze,executeFormula:()=>lt,getFormulaEditorInfoAtPosition:()=>rt,getMessageForFormulaEvaluatorError:()=>Xe.OY,getMessageForFormulaTypecheckError:()=>Xe.ic,getNodeOfInterestForFormulaTypecheckError:()=>Xe.sB,parseFormulaInput:()=>ve,processFormulaInput:()=>y});var r=n(68626),o=n(7406),a=n(77090),i=n(6287),s=n(70203),p=n(97880),l=n(82433);function u(e,t,n){let r=0,o=0;for(let a=0;a<e.length;a++){const i=e[a];switch(i.type){case"code":if(o+i.length>=t)return r+(t-o);r+=i.length,o+=i.length;break;case"token":if(o+i.length>=t)return r+("right"===n?1:0);r+=1,o+=i.length}}return o}function y(e){let t="";const n=[];return e.forEach((e=>{const r=(0,s.hD)(e),o=(0,l._u)(r);if(void 0!==o)return t+=o,void n.push({type:"token",length:o.length});const a=(0,s.Wi)(e);t+=a,n.push({type:"code",length:a.length})})),[t,n]}function c(e,t){return{...e,startOffset:u(t,e.startOffset,"left"),endOffset:u(t,e.endOffset,"left")}}var d=n(47218);const f=(0,a.V3)({name:"AdditionOperator",pattern:a.hW.NA}),m=(0,a.V3)({name:"UnaryOperator",pattern:a.hW.NA}),v=(0,a.V3)({name:"Plus",pattern:/\+/,categories:f}),h=(0,a.V3)({name:"Minus",pattern:/-/,categories:[f,m]}),x=(0,a.V3)({name:"ExclamationPoint",pattern:/!/,categories:m}),b=(0,a.V3)({name:"MultiplicationOperator",pattern:a.hW.NA}),g=(0,a.V3)({name:"Multi",pattern:/\*/,categories:b}),k=(0,a.V3)({name:"Div",pattern:/\//,categories:b}),T=(0,a.V3)({name:"Modulo",pattern:/%/,categories:b}),O=(0,a.V3)({name:"Caret",pattern:/\^/}),E=(0,a.V3)({name:"BooleanLiteral",pattern:a.hW.NA}),w=(0,a.V3)({name:"True",pattern:/true/i,categories:E}),U=(0,a.V3)({name:"False",pattern:/false/i,categories:E}),L=(0,a.V3)({name:"And",pattern:/and|&&/i}),P=(0,a.V3)({name:"Or",pattern:/or|\|\|/i}),M=(0,a.V3)({name:"Not",pattern:/not/i,categories:m}),S=(0,a.V3)({name:"RelationalOperator",pattern:a.hW.NA}),C=(0,a.V3)({name:"LessThan",pattern:/<=?/,categories:S}),N=(0,a.V3)({name:"GreaterThan",pattern:/>=?/,categories:S}),R=(0,a.V3)({name:"EqualityOperator",pattern:a.hW.NA}),I=(0,a.V3)({name:"Equal",pattern:/=/,categories:R}),A=(0,a.V3)({name:"NotEqual",pattern:/!=/,categories:R}),B=(0,a.V3)({name:"LParen",pattern:/\(/}),F=(0,a.V3)({name:"RParen",pattern:/\)/}),G=(0,a.V3)({name:"LBracket",pattern:/\[/}),V=(0,a.V3)({name:"RBracket",pattern:/\]/}),$=(0,a.V3)({name:"Comma",pattern:/,/}),W=(0,a.V3)({name:"Dot",pattern:/\./}),D=(0,a.V3)({name:"QuestionMark",pattern:/\?/}),Y=(0,a.V3)({name:"Colon",pattern:/:/}),q=(0,a.V3)({name:"StringLiteral",pattern:/"(?:[^\\"]|\\.)*"/,start_chars_hint:['"']}),_=(0,a.V3)({name:"UnclosedStringLiteral",pattern:/"(?:[^\\"]|\\.)*/,start_chars_hint:['"']}),j=(0,a.V3)({name:"NumberLiteral",pattern:/(0|[1-9]\d*)(\.\d+)?([eE][+-]?\d+)?/}),Z=(0,a.V3)({name:"Comment",pattern:/\/\*(?:[^*]|\*(?:[^\/]))*\*\//,group:a.hW.SKIPPED,start_chars_hint:["/*"]}),X=(0,a.V3)({name:"UnclosedComment",pattern:/\/\*(?:[^*]|\*(?:[^\/]))*/,group:a.hW.SKIPPED,start_chars_hint:["/*"]}),J="[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}",K=l.Eb.replace(/\{/g,"\\{"),z=l.Av.replace(/\}/g,"\\}"),Q=new RegExp(`${K}.*${z}`),H=new RegExp(`^${K}${l.Oy.Block}:(${J})(:${J})?${z}`),ee=new RegExp(`^${K}${l.Oy.Person}:(${J})${z}`),te=new RegExp(`^${K}${l.Oy.BlockProperty}:([^:]+)(:(${J}):(${J}))?${z}`),ne=new RegExp(`^${K}${l.Oy.UserProperty}:(${Object.values(l.V2).join("|")})${z}`),re=new RegExp(`^${K}${l.Oy.Checkbox}:(true|false)${z}`),oe=new RegExp(`^${K}${l.Oy.ContextValue}:([^}]+)${z}`),ae=new RegExp(`^${K}${l.Oy.Date}:([^}]+)${z}`),ie=(0,a.V3)({name:"InputToken",pattern:{exec:(e,t)=>{if(!e.startsWith(l.Eb,t))return null;const n=e.substring(t),r=te.exec(n);if(null!==r){const e=[r[0]],t=(0,l.i0)(r[1]);let n;if(void 0!==r[2])n={type:l.Oy.BlockProperty,property:t,collection:{table:i.v,id:r[3],spaceId:r[4]}};else{if(!l.WG.includes(t))return null;n={type:l.Oy.BlockProperty,property:t,collection:void 0}}return e.payload=n,e}const o=H.exec(n);if(null!==o){const e=[o[0]],t={type:l.Oy.Block,blockId:o[1],spaceId:void 0!==o[2]?o[2].substring(1):void 0};return e.payload=t,e}const a=ee.exec(n);if(null!==a){const e=[a[0]],t={type:l.Oy.Person,userId:a[1]};return e.payload=t,e}const s=ne.exec(n);if(null!==s){const e=[s[0]],t={type:l.Oy.UserProperty,userProperty:s[1]};return e.payload=t,e}const p=re.exec(n);if(null!==p){const e=[p[0]],t={type:l.Oy.Checkbox,checked:"true"===p[1]};return e.payload=t,e}const u=oe.exec(n);if(null!==u){const e=[u[0]],t=(0,l.wf)(u[1]),n={type:l.Oy.ContextValue,valueId:t};return e.payload=n,e}const y=ae.exec(n);if(null!==y){const e=[y[0]],t={type:l.Oy.Date,date:(0,l.DF)(y[1])};return e.payload=t,e}return null}},line_breaks:!1,start_chars_hint:[l.Eb]}),se=(0,a.V3)({name:"IdentifierName",pattern:/([A-Za-z_][A-Za-z0-9_]*)/}),pe={WhiteSpace:(0,a.V3)({name:"WhiteSpace",pattern:/\s+/,group:a.hW.SKIPPED}),NumberLiteral:j,StringLiteral:q,UnclosedStringLiteral:_,Comment:Z,UnclosedComment:X,InputToken:ie,True:w,False:U,And:L,Or:P,Not:M,IdentifierName:se,Equal:I,NotEqual:A,Plus:v,Minus:h,ExclamationPoint:x,Multi:g,Div:k,Modulo:T,Caret:O,LParen:B,RParen:F,LBracket:G,RBracket:V,AdditionOperator:f,MultiplicationOperator:b,LessThan:C,GreaterThan:N,QuestionMark:D,Colon:Y,Comma:$,Dot:W},le=Object.values(pe),ue=new a.hW(Object.values(le));class ye extends a.wd{constructor(){super(le,{recoveryEnabled:!0,nodeLocationTracking:"onlyOffset"}),this.expression=this.RULE("expression",(()=>{this.SUBRULE(this.conditionalExpression)})),this.primaryExpression=this.RULE("primaryExpression",(()=>this.OR([{ALT:()=>this.SUBRULE(this.parenthesisExpression)},{ALT:()=>this.SUBRULE(this.arrayExpression)},{ALT:()=>this.CONSUME(j)},{ALT:()=>this.CONSUME(q)},{ALT:()=>this.CONSUME(_)},{ALT:()=>this.CONSUME(E)},{ALT:()=>this.CONSUME(se)},{ALT:()=>this.CONSUME(ie)}]))),this.conditionalExpression=this.RULE("conditionalExpression",(()=>{this.SUBRULE(this.logicalOrExpression,{LABEL:"condition"}),this.OPTION((()=>{this.CONSUME(D),this.SUBRULE2(this.logicalOrExpression,{LABEL:"expIfTrue"}),this.CONSUME(Y),this.SUBRULE3(this.logicalOrExpression,{LABEL:"expIfFalse"})}))})),this.logicalOrExpression=this.RULE("logicalOrExpression",(()=>{this.SUBRULE(this.logicalAndExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(P),this.SUBRULE2(this.logicalAndExpression,{LABEL:"rhs"})}))})),this.logicalAndExpression=this.RULE("logicalAndExpression",(()=>{this.SUBRULE(this.equalityExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(L),this.SUBRULE2(this.equalityExpression,{LABEL:"rhs"})}))})),this.equalityExpression=this.RULE("equalityExpression",(()=>{this.SUBRULE(this.relationalExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(R),this.SUBRULE2(this.relationalExpression,{LABEL:"rhs"})}))})),this.relationalExpression=this.RULE("relationalExpression",(()=>{this.SUBRULE(this.additionExpression,{LABEL:"lhs"}),this.OPTION((()=>{this.CONSUME(S),this.SUBRULE2(this.additionExpression,{LABEL:"rhs"})}))})),this.additionExpression=this.RULE("additionExpression",(()=>{this.SUBRULE(this.multiplicationExpression,{LABEL:"lhs"}),this.MANY((()=>{this.CONSUME(f),this.SUBRULE2(this.multiplicationExpression,{LABEL:"rhs"})}))})),this.multiplicationExpression=this.RULE("multiplicationExpression",(()=>{this.SUBRULE(this.exponentiationExpression,{LABEL:"lhs"}),this.MANY((()=>{this.CONSUME(b),this.SUBRULE2(this.exponentiationExpression,{LABEL:"rhs"})}))})),this.exponentiationExpression=this.RULE("exponentiationExpression",(()=>{this.SUBRULE(this.unaryExpression,{LABEL:"lhs"}),this.MANY((()=>{this.CONSUME(O),this.SUBRULE2(this.unaryExpression,{LABEL:"rhs"})}))})),this.unaryExpression=this.RULE("unaryExpression",(()=>{this.OPTION((()=>{this.CONSUME(m)})),this.SUBRULE(this.memberCallExpression)})),this.memberCallExpression=this.RULE("memberCallExpression",(()=>{this.SUBRULE(this.primaryExpression),this.MANY((()=>{this.SUBRULE2(this.memberCallSubExpression)}))})),this.memberCallSubExpression=this.RULE("memberCallSubExpression",(()=>{this.OR([{ALT:()=>this.SUBRULE(this.dotMemberExpression)},{ALT:()=>this.SUBRULE(this.callArguments)}])})),this.dotMemberExpression=this.RULE("dotMemberExpression",(()=>{this.CONSUME(W),this.OR([{ALT:()=>this.CONSUME(se)},{GATE:()=>{var e,t;const n=this.LA(1);return n.tokenType===ie&&((null===(e=n.payload)||void 0===e?void 0:e.type)===l.Oy.BlockProperty||(null===(t=n.payload)||void 0===t?void 0:t.type)===l.Oy.UserProperty)},ALT:()=>this.CONSUME(ie)}])})),this.callArguments=this.RULE("callArguments",(()=>{this.CONSUME(B),this.OPTION((()=>{this.SUBRULE(this.expression),this.MANY((()=>{this.CONSUME($),this.SUBRULE2(this.expression)}))})),this.CONSUME(F)})),this.parenthesisExpression=this.RULE("parenthesisExpression",(()=>{this.CONSUME(B),this.SUBRULE(this.expression),this.CONSUME(F)})),this.arrayExpression=this.RULE("arrayExpression",(()=>{this.CONSUME(G),this.OPTION((()=>{this.SUBRULE(this.expression),this.MANY((()=>{this.CONSUME($),this.SUBRULE2(this.expression)}))})),this.CONSUME(V)})),this.performSelfAnalysis()}}const ce=new ye;function de(e){const t=/unexpected character: ->(.+)<- at offset/.exec(e.message);if(null!==t)return{type:d.$E.InvalidCharacter,character:t[1],offset:e.offset};if("unclosed string literal"===e.message)return{type:d.$E.UnclosedStringLiteral,offset:e.offset};if("unclosed comment"===e.message)return{type:d.$E.UnclosedComment,offset:e.offset};throw new Error(`Unhandled chevrotain recognition error: ${e.message}`)}const fe={RParen:")",RBracket:"]"};function me(e){const t=e.token.tokenType===a.sd?"eof":e.token.startOffset;switch(e.name){case"MismatchedTokenException":{const n=/Expecting token of type --> (.+) <-- but found/.exec(e.message);if(null!==n){const e=n[1],r=fe[e];if(void 0!==r)return{type:d.$E.TokenExpected,token:r,offset:t}}break}case"NoViableAltException":{const n=e.context.ruleStack[e.context.ruleStack.length-1];switch(n){case"primaryExpression":return{type:d.$E.ExpressionExpected,offset:t};case"dotMemberExpression":return{type:d.$E.PropertyTokenOrFunctionExpected,offset:t}}throw new Error(`Unhandled unviable alt: ${n}`)}case"NotAllInputParsedException":return{type:d.$E.EndOfInputExpected,offset:t}}throw new Error(`Unhandled chevrotain recognition error: ${e.name}`)}function ve(e,t){const n=ue.tokenize(e),r=[...n.errors],o=[];for(const i of r)o.push(de(i));for(const i of n.tokens.filter((e=>e.tokenType===_||e.tokenType===X)))o.push({type:i.tokenType===_?d.$E.UnclosedStringLiteral:d.$E.UnclosedComment,offset:i.startOffset});for(const i of n.tokens.filter((e=>e.tokenType===q)))Q.test(i.image)&&o.push({type:d.$E.StringLiteralContainsToken,offset:t?u(t,i.startOffset,"left"):i.startOffset});ce.input=n.tokens;const a=ce.expression();for(const i of ce.errors)o.push(me(i));return[a,o]}function he(e){return e.find((e=>void 0!==e&&!isNaN(e)))}const xe=ce.getBaseCstVisitorConstructor();const be=new class extends xe{constructor(){super(),this.validateVisitor()}expression(e){return this.visit(e.conditionalExpression)}primaryExpression(e){return void 0!==e.parenthesisExpression?this.visit(e.parenthesisExpression):void 0!==e.arrayExpression?this.visit(e.arrayExpression):void 0!==e.NumberLiteral?{kind:d.bG.Number,text:e.NumberLiteral[0].image,startOffset:e.NumberLiteral[0].startOffset,endOffset:e.NumberLiteral[0].endOffset}:void 0!==e.StringLiteral?{kind:d.bG.String,text:e.StringLiteral[0].image.substring(1,e.StringLiteral[0].image.length-1),startOffset:e.StringLiteral[0].startOffset,endOffset:e.StringLiteral[0].endOffset}:void 0!==e.UnclosedStringLiteral?{kind:d.bG.String,text:e.UnclosedStringLiteral[0].image.substring(1,e.UnclosedStringLiteral[0].image.length),startOffset:e.UnclosedStringLiteral[0].startOffset,endOffset:e.UnclosedStringLiteral[0].endOffset}:void 0!==e.BooleanLiteral?{kind:d.bG.Boolean,text:e.BooleanLiteral[0].image,startOffset:e.BooleanLiteral[0].startOffset,endOffset:e.BooleanLiteral[0].endOffset}:void 0!==e.InputToken?{kind:d.bG.NotionToken,token:e.InputToken[0].payload,startOffset:e.InputToken[0].startOffset,endOffset:e.InputToken[0].endOffset}:void 0!==e.IdentifierName?{kind:d.bG.Identifier,text:e.IdentifierName[0].image,startOffset:e.IdentifierName[0].startOffset,endOffset:e.IdentifierName[0].endOffset}:{kind:d.bG.RecoveryNode,startOffset:-1,endOffset:-1}}conditionalExpression(e){const t=this.visit(e.condition[0]);var n,r,o,a,i,s;return void 0!==e.QuestionMark?{kind:d.bG.Conditional,condition:t,expIfTrue:this.visit(e.expIfTrue[0]),expIfFalse:void 0!==(null===(n=e.expIfFalse)||void 0===n?void 0:n[0])?this.visit(e.expIfFalse[0]):void 0,startOffset:e.condition[0].location.startOffset,endOffset:he([null===(r=e.expIfFalse)||void 0===r||null===(o=r[0].location)||void 0===o?void 0:o.endOffset,null===(a=e.Colon)||void 0===a||null===(i=a[0])||void 0===i?void 0:i.endOffset,null===(s=e.expIfTrue[0].location)||void 0===s?void 0:s.endOffset,e.QuestionMark[0].endOffset])}:t}logicalOrExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.Or){var n;const r=e.rhs[0];return{kind:d.bG.LogicalOr,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:he([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.Or[0].endOffset])}}return t}logicalAndExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.And){var n;const r=e.rhs[0];return{kind:d.bG.LogicalAnd,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:he([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.And[0].endOffset])}}return t}equalityExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.EqualityOperator){var n;const r=e.rhs[0];return{kind:d.bG.Equality,op:e.EqualityOperator[0].image,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:he([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.EqualityOperator[0].endOffset])}}return t}relationalExpression(e){const t=this.visit(e.lhs[0]);if(void 0!==e.RelationalOperator){var n;const r=e.rhs[0];return{kind:d.bG.Relational,op:e.RelationalOperator[0].image,lhs:t,rhs:this.visit(r),startOffset:e.lhs[0].location.startOffset,endOffset:he([null===(n=r.location)||void 0===n?void 0:n.endOffset,e.RelationalOperator[0].endOffset])}}return t}additionExpression(e){let t=this.visit(e.lhs[0]);if(void 0!==e.AdditionOperator)for(let r=0;r<e.AdditionOperator.length;r++){var n;const o=e.rhs[r];t={kind:d.bG.Additive,op:e.AdditionOperator[r].image,lhs:t,rhs:this.visit(o),startOffset:e.lhs[0].location.startOffset,endOffset:he([null===(n=o.location)||void 0===n?void 0:n.endOffset,e.AdditionOperator[r].endOffset])}}return t}multiplicationExpression(e){let t=this.visit(e.lhs[0]);if(void 0!==e.MultiplicationOperator)for(let r=0;r<e.MultiplicationOperator.length;r++){var n;const o=e.rhs[r];t={kind:d.bG.Multiplicative,op:e.MultiplicationOperator[r].image,lhs:t,rhs:this.visit(o),startOffset:e.lhs[0].location.startOffset,endOffset:he([null===(n=o.location)||void 0===n?void 0:n.endOffset,e.MultiplicationOperator[r].endOffset])}}return t}exponentiationExpression(e){let t;const n=this.visit(e.lhs[0]);if(void 0!==e.Caret){var r;const o=e.Caret.length-1;let a,i=null===(r=e.rhs[o].location)||void 0===r?void 0:r.endOffset;(void 0===i||isNaN(i))&&(i=e.Caret[o].endOffset);for(let n=e.Caret.length-1;n>=0;n--){const r=e.rhs[n];t=void 0===a?this.visit(r):{kind:d.bG.Exponentiation,op:a,lhs:this.visit(r),rhs:t,startOffset:r.location.startOffset,endOffset:i},a=e.Caret[n].image}return{kind:d.bG.Exponentiation,op:a,lhs:n,rhs:t,startOffset:e.lhs[0].location.startOffset,endOffset:i}}return n}unaryExpression(e){const t=this.visit(e.memberCallExpression[0]);return void 0!==e.UnaryOperator?{kind:d.bG.Unary,op:e.UnaryOperator[0].image.toLowerCase(),expression:t,startOffset:e.UnaryOperator[0].startOffset,endOffset:t.endOffset}:t}memberCallExpression(e){let t=this.visit(e.primaryExpression[0]),n=e.primaryExpression[0].location.startOffset;var r;isNaN(n)&&(n=null===(r=e.memberCallSubExpression)||void 0===r?void 0:r[0].location.startOffset);if(void 0!==e.memberCallSubExpression)for(const p of e.memberCallSubExpression){const e=p.location.endOffset;if(void 0!==p.children.callArguments){var o,a,i,s;const r=p.children.callArguments[0].children;t={kind:d.bG.Call,expression:t,arguments:(null===(o=p.children.callArguments[0])||void 0===o||null===(a=o.children.expression)||void 0===a?void 0:a.map((e=>this.visit(e))))??[],lParenOffset:r.LParen[0].startOffset,rParenOffset:null===(i=r.RParen)||void 0===i?void 0:i[0].startOffset,commaOffsets:(null===(s=r.Comma)||void 0===s?void 0:s.map((e=>e.startOffset)))??[],startOffset:n,endOffset:e}}else if(void 0!==p.children.dotMemberExpression){const r=p.children.dotMemberExpression[0].children;if(void 0!==r.IdentifierName){const o=r.IdentifierName[0];t={kind:d.bG.UnifiedFunctionProperty,expression:t,name:o.image,nameStartOffset:o.startOffset,nameEndOffset:o.endOffset,startOffset:n,endOffset:e}}else if(void 0!==r.InputToken){const o=r.InputToken[0],a=o.payload;switch(a.type){case l.Oy.BlockProperty:t={kind:d.bG.MemberBlockProperty,expression:t,propertyToken:void 0===a.collection?{property:a.property,collection:void 0}:{property:a.property,collection:a.collection},propertyStartOffset:o.startOffset,propertyEndOffset:o.endOffset,startOffset:n,endOffset:e};break;case l.Oy.UserProperty:t={kind:d.bG.MemberUserProperty,expression:t,userProperty:a.userProperty,propertyStartOffset:o.startOffset,propertyEndOffset:o.endOffset,startOffset:n,endOffset:e}}}}}return t}parenthesisExpression(e){return this.visit(e.expression[0])}arrayExpression(e){var t,n,r,o,a,i,s;return{kind:d.bG.Array,elements:(null===(t=e.expression)||void 0===t?void 0:t.map((e=>this.visit(e))))??[],lBracketOffset:e.LBracket[0].startOffset,rBracketOffset:null===(n=e.RBracket)||void 0===n?void 0:n[0].startOffset,commaOffsets:(null===(r=e.Comma)||void 0===r?void 0:r.map((e=>e.startOffset)))??[],startOffset:e.LBracket[0].startOffset,endOffset:he([null===(o=e.RBracket)||void 0===o?void 0:o[0].endOffset,null===(a=e.expression)||void 0===a||null===(i=a[e.expression.length-1])||void 0===i||null===(s=i.location)||void 0===s?void 0:s.endOffset,e.LBracket[0].endOffset])}}memberCallSubExpression(e){throw new Error("unexpected memberCallSubExpression")}dotMemberExpression(e){throw new Error("unexpected dotMemberExpression")}callArguments(e){throw new Error("unexpected callArguments")}};function ge(e){try{return{value:be.visit(e)}}catch(t){return{error:{type:d.$E.UnexpectedError,error:(0,o.tg)(t),offset:0}}}}var ke=n(29477),Te=n(45953),Oe=n(21202),Ee=n(19889),we=n(69282),Ue=n.n(we),Le=n(32918),Pe=n(64340),Me=n(76725),Se=n(89837),Ce=n(16953),Ne=n(4615),Re=n(63143);function Ie(e,t){return{name:e,eval:function*(e,n){return{type:"number",value:t}},returnType:{type:"number"},iconType:{type:"number"}}}function Ae(e,t){return{name:e,eval:function*(e,n){const[r]=e;return Ue()("number"===r.type),{type:"number",value:t(r.value)}},parameters:{expected:[{name:"input",type:{type:"number"}}]},returnType:{type:"number"},iconType:{type:"number"}}}const Be=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"];function*Fe(e,t){const n=yield*(0,l.PX)(e,t);if(!Be.includes(n))throw new d.Mu({type:d.sj.DateInvalidDurationUnit,invalidUnit:n});return n}function Ge(e){return function*(t,n){const[r,o,a]=t;Ue()("date"===r.type&&"number"===o.type&&"text"===a.type);const i=(0,Se.NK)(r.value,n.userTimeZone).start,s=e(i,o.value,yield*Fe(a.value,n));return{type:"date",value:"date"===r.value.type||"daterange"===r.value.type?(0,Se.hT)(s,n.userTimeZone):(0,Se.CQ)(s,n.userTimeZone)}}}function Ve(e){return function*(t,n){const[r]=t;return Ue()("date"===r.type),{type:"number",value:e((0,Se.NK)((0,Le.Ws)(r.value),n.userTimeZone,n.intl.locale).start)}}}const $e="currentValue",We={expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"expression",type:{type:"expression"},augmentScope:e=>{var t;return{[$e]:"array"===(null===(t=e[0])||void 0===t?void 0:t.type)?e[0].of:{type:"unknown"}}}}]};function De(e,t,n){return(0,l.LD)(e.map((e=>je(t,{...n,values:[{kind:l.yp.Binding,id:$e,value:e},...n.values]}))))}const Ye={type:"undefined"},qe={joinText:{name:"joinText",eval:function*(e){const[t,...n]=e;return Ue()("text"===t.type),{type:"text",value:(0,s.Zx)((0,Me.Z)(n.map((e=>(Ue()("text"===e.type),e.value))),(()=>t.value)).flat())}},parameters:{expected:[{name:"joiner",type:{type:"text"}}],varargs:[{name:"arg",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},substring:{name:"substring",eval:function*(e,t){const[n,r,o]=e;Ue()("text"===n.type&&"number"===r.type);return{type:"text",value:[[(yield*(0,l.PX)(n.value,t)).substring(r.value,"number"===(null==o?void 0:o.type)?o.value:void 0)]]}},parameters:{expected:[{name:"target",type:{type:"text"}},{name:"startIndex",type:{type:"number"}},{name:"endIndex",optional:!0,type:{type:"number"}}]},returnType:{type:"text"},iconType:{type:"text"}},length:{name:"length",eval:function*(e,t){const[n]=e;return"array"===n.type?{type:"number",value:n.values.length}:(Ue()("text"===n.type),{type:"number",value:n.value.reduce(((e,t)=>e+(0,s.J1)(t)),0)})},parameters:{expected:[{name:"input",type:[{type:"text"},{type:"array",of:{type:"unknown"}}]}]},returnType:{type:"number"},iconType:{type:"text"}},format:{name:"format",eval:function*(e,t){const[n]=e;return Ue()("text"===n.type),{type:"text",value:(0,s.TP)(yield*(0,l.PX)(n.value,t))}},parameters:{expected:[{name:"input",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},contains:{name:"contains",eval:function*(e,t){const[n,r]=e;Ue()("text"===n.type&&"text"===r.type);const o=yield*(0,l.PX)(n.value,t),a=yield*(0,l.PX)(r.value,t);return{type:"checkbox",value:o.includes(a)}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"searchString",type:{type:"text"}}]},returnType:{type:"checkbox"},iconType:{type:"text"}},replace:{name:"replace",eval:function*(e,t){const[n,r,o]=e;Ue()("text"===n.type&&"text"===r.type);const a=yield*(0,l.PX)(n.value,t),i=yield*(0,l.PX)(r.value,t);return{type:"text",value:(0,s.TP)(a.replace(new RegExp(i),"text"===(null==o?void 0:o.type)?yield*(0,l.PX)(o.value,t):""))}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"pattern",type:{type:"text"}},{name:"replacement",optional:!0,type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},replaceAll:{name:"replaceAll",eval:function*(e,t){const[n,r,o]=e;Ue()("text"===n.type&&"text"===r.type);const a=yield*(0,l.PX)(n.value,t);return{type:"text",value:(0,s.TP)(a.replace(new RegExp(yield*(0,l.PX)(r.value,t),"g"),"text"===(null==o?void 0:o.type)?yield*(0,l.PX)(o.value,t):""))}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"pattern",type:{type:"text"}},{name:"replacement",optional:!0,type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},test:{name:"test",eval:function*(e,t){const[n,r]=e;return Ue()("text"===n.type&&"text"===r.type),{type:"checkbox",value:new RegExp(yield*(0,l.PX)(r.value,t)).test(yield*(0,l.PX)(n.value,t))}},parameters:{expected:[{name:"input",type:{type:"text"}},{name:"pattern",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"text"}},empty:{name:"empty",eval:function*(e,t){const[n]=e;return{type:"checkbox",value:"array"===n.type?0===n.values.length:!(0,l.vh)(n)}},parameters:{expected:[{name:"input",type:{type:"unknown"}}]},returnType:{type:"checkbox"},iconType:{type:"unknown"}},toNumber:{name:"toNumber",eval:function*(e,t){const[n]=e;switch(n.type){case"number":return n;case"checkbox":return{type:"number",value:n.value?1:0};case"text":{const e=yield*(0,l.PX)(n.value,t),r=parseFloat(e);return(0,Re.hj)(r)?{type:"number",value:parseFloat(e)}:Ye}case"date":return{type:"number",value:(0,Se.NK)(n.value,t.userTimeZone).start.valueOf()};default:return Ye}},parameters:{expected:[{name:"input",type:{type:"unknown"}}]},returnType:{type:"number"},iconType:{type:"number"}},e:Ie("e",Math.E),pi:Ie("pi",Math.PI),abs:Ae("abs",Math.abs),ceil:Ae("ceil",Math.ceil),floor:Ae("floor",Math.floor),round:Ae("round",Math.round),sqrt:Ae("cbrt",Math.sqrt),cbrt:Ae("cbrt",Math.cbrt),exp:Ae("exp",Math.exp),ln:Ae("ln",Math.log),log10:Ae("log10",Math.log10),log2:Ae("log2",Math.log2),sign:Ae("sign",Math.sign),min:{name:"min",eval:function*(e,t){const n=e;return{type:"number",value:Math.min(...n.map((e=>(Ue()("number"===e.type),e.value))))}},parameters:{expected:[{name:"arg",type:{type:"number"}}],varargs:[{name:"arg",type:{type:"number"}}]},returnType:{type:"number"},iconType:{type:"number"}},max:{name:"max",eval:function*(e,t){const n=e;return{type:"number",value:Math.max(...n.map((e=>(Ue()("number"===e.type),e.value))))}},parameters:{expected:[{name:"arg",type:{type:"number"}}],varargs:[{name:"arg",type:{type:"number"}}]},returnType:{type:"number"},iconType:{type:"number"}},dateStart:{name:"dateStart",eval:function*(e,t){const[n]=e;return Ue()("date"===n.type),{type:"date",value:(0,Le.Ws)(n.value)}},parameters:{expected:[{name:"input",type:{type:"date"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateEnd:{name:"dateEnd",eval:function*(e,t){const[n]=e;return Ue()("date"===n.type),{type:"date",value:(0,Le.S$)(n.value)}},parameters:{expected:[{name:"input",type:{type:"date"}}]},returnType:{type:"date"},iconType:{type:"date"}},now:{name:"now",eval:function*(e,t){return{type:"date",value:(0,Se.R_)(t.userTimeZone)}},parameters:{},returnType:{type:"date"},iconType:{type:"date"}},timestamp:{name:"timestamp",eval:function*(e,t){const[n]=e;return Ue()("date"===n.type),{type:"number",value:(0,Se.uO)(n.value,t.userTimeZone)}},parameters:{expected:[{name:"input",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},fromTimestamp:{name:"fromTimestamp",eval:function*(e,t){const[n]=e;return Ue()("number"===n.type),{type:"date",value:(0,Se.CQ)(n.value,t.userTimeZone)}},parameters:{expected:[{name:"input",type:{type:"number"}}]},returnType:{type:"date"},iconType:{type:"date"}},parseDate:{name:"parseDate",eval:function*(e,t){const[n]=e;Ue()("text"===n.type);const r=yield*(0,l.PX)(n.value,t),o=(0,Ce.fuzzyValidDateTimeFromISO)(r);return o?{type:"date",value:(0,Ce.luxonDateToNotionDateOrDateTime)(o)}:Ye},parameters:{expected:[{name:"dateString",type:{type:"text"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateAdd:{name:"dateAdd",eval:Ge(((e,t,n)=>e.plus({[n]:t}).valueOf())),parameters:{expected:[{name:"input",type:{type:"date"}},{name:"num",type:{type:"number"}},{name:"unit",type:{type:"text"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateSubtract:{name:"dateSubtract",eval:Ge(((e,t,n)=>e.minus({[n]:t}).valueOf())),parameters:{expected:[{name:"input",type:{type:"date"}},{name:"num",type:{type:"number"}},{name:"unit",type:{type:"text"}}]},returnType:{type:"date"},iconType:{type:"date"}},dateBetween:{name:"dateBetween",eval:function*(e,t){const[n,r,o]=e;Ue()("date"===n.type&&"date"===r.type&&"text"===o.type);const a=(0,Se.NK)(n.value,t.userTimeZone).start,i=(0,Se.NK)(r.value,t.userTimeZone).start,s=yield*Fe(o.value,t);return{type:"number",value:Math.trunc(a.diff(i,s).get(s))}},parameters:{expected:[{name:"left",type:{type:"date"}},{name:"right",type:{type:"date"}},{name:"unit",type:{type:"text"}}]},returnType:{type:"number"},iconType:{type:"date"}},formatDate:{name:"formatDate",eval:function*(e,t){const[n,r]=e;Ue()("date"===n.type&&"text"===r.type);const o=(0,Se.NK)((0,Le.Ws)(n.value),t.userTimeZone,t.intl.locale).start;return{type:"text",value:(0,s.TP)((0,Pe.P)(o,yield*(0,l.PX)(r.value,t)))}},parameters:{expected:[{name:"date",type:{type:"date"}},{name:"format",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"date"}},minute:{name:"minute",eval:Ve((e=>e.minute)),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},hour:{name:"hour",eval:Ve((e=>e.hour)),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},day:{name:"day",eval:Ve((e=>e.weekday)),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},date:{name:"date",eval:Ve((e=>e.day)),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},month:{name:"month",eval:Ve((e=>e.month)),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},year:{name:"year",eval:Ve((e=>e.year)),parameters:{expected:[{name:"date",type:{type:"date"}}]},returnType:{type:"number"},iconType:{type:"date"}},if:{name:"if",eval:function*(e,t){const[n,r,o]=e;return Ue()("checkbox"===n.type),n.value?yield*je(r,t):yield*je(o,t)},parameters:{expected:[{name:"condition",type:{type:"checkbox"}},{name:"ifTrue",type:{type:"expression"}},{name:"ifFalse",type:{type:"expression"}}]},returnType:e=>{let[t,n,r]=e;return void 0!==n&&void 0!==r&&(0,l.Jy)(n,r)?n:{type:"unknown"}},iconType:{type:"checkbox"}},ifs:{name:"ifs",parameters:{expected:[{name:"condition",type:{type:"expression"}},{name:"ifTrue",type:{type:"expression"}}],varargs:[{name:"args",type:{type:"expression"}}]},returnType:e=>{if(e.length<2)return{type:"unknown"};const t=e[1];let n=2;for(;n<e.length-1;n+=2)if(!(0,l.Jy)(e[n+1],t))return{type:"unknown"};if(n<e.length){const r=e[n];if(!(0,l.Jy)(r,t))return{type:"unknown"}}return t},eval:function*(e,t){const n=e;let r=0;for(;r<n.length-1;r+=2){const e=yield*je(n[r],t);if((0,l.vh)(e))return yield*je(n[r+1],t)}return r<n.length?yield*je(n[r],t):Ye},iconType:{type:"checkbox"}},sum:{name:"sum",eval:function*(e,t){return{type:"number",value:e.reduce(((e,t)=>e+("number"===t.type?t.value:"array"===t.type?t.values.reduce(((e,t)=>e+("number"===t.type?t.value:0)),0):0)),0)}},parameters:{varargs:[{name:"value",type:[{type:"number"},{type:"array",of:{type:"number"}}]}]},returnType:{type:"number"},iconType:{type:"number"}},at:{name:"at",eval:function*(e,t){const[n,r]=e;return Ue()("array"===n.type&&"number"===r.type),void 0!==n.values[r.value]?n.values[r.value]:Ye},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"index",type:{type:"number"}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},concat:{name:"concat",eval:function*(e){return{type:"array",values:e.flatMap((e=>(Ue()("array"===e.type),e.values)))}},parameters:{varargs:[{name:"arg",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{var t;if("array"===(null===(t=e[0])||void 0===t?void 0:t.type))return{type:"array",of:{type:"unknown"}};const n=e[0];for(let r=1;r<e.length;r++)if(void 0!==e[r]&&!(0,l.Jy)(e[r],n))return{type:"array",of:{type:"unknown"}};return n},iconType:{type:"array",of:{type:"unknown"}}},every:{name:"every",eval:function*(e,t){const[n,r]=e;Ue()("array"===n.type);return{type:"checkbox",value:(yield*De(n.values,r,t)).every((e=>(0,l.vh)(e)))}},parameters:We,returnType:{type:"checkbox"},iconType:{type:"array",of:{type:"unknown"}}},filter:{name:"filter",eval:function*(e,t){const[n,r]=e;Ue()("array"===n.type);const o=yield*De(n.values,r,t);return{type:"array",values:n.values.filter(((e,t)=>(0,l.vh)(o[t])))}},parameters:We,returnType:e=>{let[t,n]=e;return"array"===(null==t?void 0:t.type)?t:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},find:{name:"find",eval:function*(e,t){const[n,r]=e;Ue()("array"===n.type);const o=yield*De(n.values,r,t);return n.values.find(((e,t)=>(0,l.vh)(o[t])))??{type:"undefined"}},parameters:We,returnType:e=>{let[t,n]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"text"}},findIndex:{name:"findIndex",eval:function*(e,t){const[n,r]=e;Ue()("array"===n.type);return{type:"number",value:(yield*De(n.values,r,t)).findIndex((e=>(0,l.vh)(e)))}},parameters:We,returnType:e=>{let[t,n]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"text"}},first:{name:"first",eval:function*(e,t){const[n]=e;return Ue()("array"===n.type),n.values.length>0?n.values[0]:Ye},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},flat:{name:"flat",eval:function*(e,t){const[n]=e;Ue()("array"===n.type);const r=[];for(const o of n.values)"array"===o.type?r.push(...o.values):r.push(o);return{type:"array",values:r}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e,n={type:"unknown"};return"array"===(null==t?void 0:t.type)&&(n="array"===t.of.type?t.of.of:t.of),{type:"array",of:n}},iconType:{type:"array",of:{type:"unknown"}}},join:{name:"join",eval:function*(e){const[t,n]=e;return Ue()("array"===t.type&&"text"===n.type),{type:"text",value:(0,s.Zx)((0,Me.Z)(t.values.map((e=>(Ue()("text"===e.type),e.value))),(()=>n.value)).flat())}},parameters:{expected:[{name:"input",type:{type:"array",of:{type:"text"}}},{name:"joiner",type:{type:"text"}}]},returnType:{type:"text"},iconType:{type:"array",of:{type:"unknown"}}},includes:{name:"includes",eval:function*(e,t){const[n,r]=e;Ue()("array"===n.type);for(const o of n.values)if((0,l.Jr)(o,r))return{type:"checkbox",value:!0};return{type:"checkbox",value:!1}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"needle",type:{type:"unknown"}}]},returnType:{type:"checkbox"},iconType:{type:"array",of:{type:"unknown"}}},last:{name:"last",eval:function*(e,t){const[n]=e;return Ue()("array"===n.type),n.values.length>0?n.values[n.values.length-1]:Ye},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t.of:{type:"unknown"}},iconType:{type:"array",of:{type:"unknown"}}},map:{name:"map",eval:function*(e,t){const[n,r]=e;return Ue()("array"===n.type),{type:"array",values:yield*De(n.values,r,t)}},parameters:We,returnType:e=>{let[t,n]=e;return{type:"array",of:n??{type:"unknown"}}},iconType:{type:"array",of:{type:"text"}}},reverse:{name:"reverse",eval:function*(e,t){const[n]=e;Ue()("array"===n.type);return{type:"array",values:[...n.values].reverse()}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===t.type?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},slice:{name:"slice",eval:function*(e,t){const[n,r,o]=e;return Ue()("array"===n.type&&"number"===r.type),{type:"array",values:n.values.slice(r.value,"number"===(null==o?void 0:o.type)?o.value:void 0)}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}},{name:"startIndex",type:{type:"number"}},{name:"endIndex",optional:!0,type:{type:"number"}}]},returnType:e=>{let[t]=e;return"array"===(null==t?void 0:t.type)?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},some:{name:"some",eval:function*(e,t){const[n,r]=e;Ue()("array"===n.type);return{type:"checkbox",value:(yield*De(n.values,r,t)).some((e=>(0,l.vh)(e)))}},parameters:We,returnType:{type:"checkbox"},iconType:{type:"array",of:{type:"unknown"}}},sort:{name:"sort",eval:function*(e,t){const[n]=e;Ue()("array"===n.type);return{type:"array",values:yield*(0,l.Ex)(n.values,t)}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===t.type?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},unique:{name:"unique",eval:function*(e,t){const[n]=e;Ue()("array"===n.type);const r=[];return n.values.forEach((e=>{r.some((t=>(0,l.Jr)(t,e)))||r.push(e)})),{type:"array",values:r}},parameters:{expected:[{name:"list",type:{type:"array",of:{type:"unknown"}}}]},returnType:e=>{let[t]=e;return"array"===t.type?t:{type:"array",of:{type:"unknown"}}},iconType:{type:"array",of:{type:"unknown"}}},_toPlainText:{name:"_toPlainText",eval:function*(e,t){const[n]=e;return Ue()("text"===n.type),{type:"text",value:(0,s.TP)(yield*(0,l.PX)(n.value,t))}},parameters:{expected:[{name:"input",type:{type:"text"}}]},returnType:()=>({type:"text"}),iconType:{type:"text"}},_toText:{name:"_toText",eval:function*(e,t){const[n]=e;return{type:"text",value:(0,l.j4)(n)}},parameters:{expected:[{name:"input",type:{type:"unknown"}}]},returnType:()=>({type:"text"}),iconType:{type:"text"}},let:{name:"let",eval:function*(e,t){const[n,r,o]=e;if(n.kind!==d.bG.Identifier)throw new d.Mu({type:d.sj.LetBindingNameNotIdentifier,node:n});return yield*je(o,{...t,values:[{kind:l.yp.Binding,id:n.text,value:yield*je(r,t)},...t.values]})},parameters:{expected:[{name:"identifier",type:{type:"expression"}},{name:"value",type:{type:"expression"}},{name:"expression",type:{type:"expression"}}]},returnType:e=>{let[t,n,r]=e;return r??{type:"unknown"}},iconType:{type:"text"}},_idDeprecated:{name:"_idDeprecated",eval:function*(e,t){var n;const r=null===(n=t.values.find((e=>e.kind===l.yp.ThisRow)))||void 0===n?void 0:n.value;if("block"!==(null==r?void 0:r.type))throw new d.Mu({type:d.sj.TryingToGetIdWithoutThisRow});return{type:"text",value:(0,s.TP)((0,Ne.cj)(r.value.id))}},returnType:()=>({type:"text"}),iconType:{type:"text"}}};function _e(e,t,n){if("number"!==t.type&&"undefined"!==t.type)throw new d.WV({type:d.FY.CannotDoMathOnType,op:n,operand:e,valueType:t.type})}function*je(e,t){switch(e.kind){case d.bG.Number:return{type:"number",value:parseFloat(e.text)};case d.bG.String:return{type:"text",value:[[e.text.replace(/\\([\\"])/g,"$1")]]};case d.bG.Boolean:return{type:"checkbox",value:"true"===e.text.toLowerCase()};case d.bG.NotionToken:{const r=e.token;switch(r.type){case l.Oy.Checkbox:return{type:"checkbox",value:r.checked};case l.Oy.BlockProperty:{const n=t.values.find((e=>e.kind===l.yp.ThisRow));if("block"!==(null==n?void 0:n.value.type))throw new d.WV({type:d.FY.MissingThisRow,node:e});const o=n.value.value,a=(yield{recordPointers:[o]}).getRecordModel(o);if(void 0===a)throw new d.WV({type:d.FY.MissingThisRow,node:e});if(void 0===r.collection)return(0,l.SQ)(a,r.property);const s=(0,l.SR)(r.property),p={table:i.v,id:a.getParentId(),spaceId:a.getSpaceId()};if(!(0,Te.qo)(r.collection,p))throw new d.WV({type:d.FY.ThisRowBlockPropertyMismatchCollection,node:e,thisRowCollection:p});const u=(yield{recordPointers:[p]}).getRecordModel(p),y=null==u?void 0:u.getNormalizedSchema(),c=null==y?void 0:y[s];if(void 0===c||void 0===y)throw new d.WV({type:d.FY.MissingSchemaPropertyOnThisRow,node:e,collectionId:a.getParentId(),property:s});return yield*(0,l.iC)(a,s,y,c,t)}case l.Oy.Block:return{type:"block",value:{table:Oe.iU,id:r.blockId,spaceId:r.spaceId}};case l.Oy.ContextValue:{var n;const o=null===(n=t.values.find((e=>e.kind===l.yp.ContextValue&&e.id===(0,l.Kv)(r.valueId))))||void 0===n?void 0:n.value;if(void 0===o)throw new d.WV({type:d.FY.MissingContextVariable,node:e,valueId:r.valueId});return o}case l.Oy.Date:return{type:"date",value:r.date};case l.Oy.Person:return{type:"person",value:{table:Ee.KJ,id:r.userId}};case l.Oy.UserProperty:throw new d.WV({type:d.FY.NonMemberUserProperty,node:e});default:(0,p.t1)(r)}break}case d.bG.Identifier:{var r;const n=null===(r=t.values.find((t=>t.kind===l.yp.Binding&&t.id===e.text)))||void 0===r?void 0:r.value;if(void 0!==n)return n;if(e.text in qe)return{type:"function",function:qe[e.text]};throw new d.WV({type:d.FY.IdentifierNotFound,node:e})}case d.bG.Array:return{type:"array",values:yield*(0,l.LD)(e.elements.map((e=>je(e,t))))};case d.bG.Conditional:{const n=yield*je(e.condition,t);return(0,l.vh)(n)?yield*je(e.expIfTrue,t):yield*je(e.expIfFalse,t)}case d.bG.LogicalOr:{const[n,r]=yield*(0,l.LD)([je(e.lhs,t),je(e.rhs,t)]);return{type:"checkbox",value:(0,l.vh)(n)||(0,l.vh)(r)}}case d.bG.LogicalAnd:{const[n,r]=yield*(0,l.LD)([je(e.lhs,t),je(e.rhs,t)]);return{type:"checkbox",value:(0,l.vh)(n)&&(0,l.vh)(r)}}case d.bG.Equality:{const[n,r]=yield*(0,l.LD)([je(e.lhs,t),je(e.rhs,t)]);switch(e.op){case"=":return{type:"checkbox",value:(0,l.Jr)(n,r)};case"!=":return{type:"checkbox",value:!(0,l.Jr)(n,r)}}break}case d.bG.Relational:{const[n,r]=yield*(0,l.LD)([je(e.lhs,t),je(e.rhs,t)]);if("date"===n.type&&"date"===r.type){const o=(0,l.SU)(n.value,r.value,t.userTimeZone);switch(e.op){case"<":return{type:"checkbox",value:o<0};case"<=":return{type:"checkbox",value:o<=0};case">":return{type:"checkbox",value:o>0};case">=":return{type:"checkbox",value:o>=0}}}if("number"===n.type&&"number"===r.type)switch(e.op){case"<":return{type:"checkbox",value:n.value<r.value};case"<=":return{type:"checkbox",value:n.value<=r.value};case">":return{type:"checkbox",value:n.value>r.value};case">=":return{type:"checkbox",value:n.value>=r.value}}throw new d.WV({type:d.FY.CannotRelativelyCompareTypes,lhs:e.lhs,rhs:e.rhs,lhsType:n.type,rhsType:r.type})}case d.bG.Additive:{let[n,r]=yield*(0,l.LD)([je(e.lhs,t),je(e.rhs,t)]);if("undefined"===n.type&&"undefined"===r.type)return{type:"number",value:0};switch("undefined"===n.type&&"number"===r.type?n={type:"number",value:0}:"undefined"===r.type&&"number"===n.type&&(r={type:"number",value:0}),e.op){case"+":return"number"===n.type&&"number"===r.type?{type:"number",value:n.value+r.value}:{type:"text",value:(0,s.Zx)((0,l.j4)(n).concat((0,l.j4)(r)))};case"-":if(_e(e.lhs,n,e.op),_e(e.rhs,r,e.op),"number"===n.type&&"number"===r.type)return{type:"number",value:n.value-r.value}}return{type:"undefined"}}case d.bG.Multiplicative:{const[n,r]=yield*(0,l.LD)([je(e.lhs,t),je(e.rhs,t)]);switch(_e(e.lhs,n,e.op),_e(e.rhs,r,e.op),e.op){case"*":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value*r.value};break;case"/":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value/r.value};break;case"%":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value%r.value}}return{type:"undefined"}}case d.bG.Exponentiation:{const[n,r]=yield*(0,l.LD)([je(e.lhs,t),je(e.rhs,t)]);switch(_e(e.lhs,n,e.op),_e(e.rhs,r,e.op),e.op){case"^":if("number"===n.type&&"number"===r.type)return{type:"number",value:n.value**r.value}}return{type:"undefined"}}case d.bG.Unary:{const n=yield*je(e.expression,t);switch(e.op){case"-":if("number"!==n.type)throw new d.WV({type:d.FY.UnaryMinusOnNonNumber,node:e.expression,expressionType:n.type});return{type:"number",value:-n.value};case"!":case"not":return{type:"checkbox",value:!(0,l.vh)(n)}}throw new Error("unexpected unary operator")}case d.bG.Call:{const n=yield*je(e.expression,t);if("function"!==n.type)throw new d.WV({type:d.FY.CannotCallNonFunction,node:e,calleeType:n.type});const r=n.function,a=(0,l.P2)(r),i=void 0!==n.boundTarget?[n.boundTarget,...e.arguments]:e.arguments;if(i.length<a)throw new d.WV({type:d.FY.FunctionCallTooFewArguments,node:e,libraryFunction:r,numArguments:i.length});const s=yield*(0,l.LD)(i.map(((n,o)=>function*(e,t,n,r,o){const a=(0,l.J3)(r,n);if(void 0===a)throw new d.WV({type:d.FY.FunctionCallUnexpectedArgument,node:e,argument:t,libraryFunction:r,parameterIndex:n});if(!Array.isArray(a.type)&&"expression"===a.type.type)return t;const i=yield*je(t,o);if(!(0,l.mB)(i,a.type)){if(Array.isArray(a.type)?a.type.some((e=>"checkbox"===e.type)):"checkbox"===a.type.type)return{type:"checkbox",value:(0,l.vh)(i)};if(Array.isArray(a.type)?a.type.some((e=>"text"===e.type)):"text"===a.type.type)return{type:"text",value:(0,l.j4)(i)};throw new d.WV({type:d.FY.FunctionCallArgumentWrongType,node:e,argument:t,libraryFunction:r,parameterIndex:n,argumentType:i.type})}return i}(e,n,o,r,t))));try{return yield*r.eval(s,t)}catch(o){throw new d.WV({type:d.FY.LibraryFunctionExecutionError,node:e,libraryFunction:r,error:o})}}case d.bG.UnifiedFunctionProperty:if(e.name in qe)return{type:"function",function:qe[e.name],boundTarget:e.expression};throw new d.WV({type:d.FY.UnifiedFunctionPropertyNotFound,node:e});case d.bG.MemberBlockProperty:{const n=yield*je(e.expression,t);if("undefined"===n.type)return{type:"undefined"};if("block"!==n.type)throw new d.WV({type:d.FY.AccessingPropertyOnNonBlock,node:e,expressionValue:n});const r=(yield{recordPointers:[n.value]}).getRecordModel(n.value);if(void 0===r)throw new d.WV({type:d.FY.MissingDataDependencyBlock,node:e,blockPointer:n.value});if(void 0===e.propertyToken.collection)return(0,l.SQ)(r,e.propertyToken.property);const o={table:i.v,id:r.getParentId(),spaceId:r.getSpaceId()},a=(0,l.SR)(e.propertyToken.property);if(!(0,Te.qo)(e.propertyToken.collection,o))throw new d.WV({type:d.FY.MemberPropertyMismatchCollection,node:e,blockCollection:o});const s=(yield{recordPointers:[o]}).getRecordModel(o),p=null==s?void 0:s.getNormalizedSchema(),u=null==p?void 0:p[a];if(void 0===u||void 0===p)throw new d.WV({type:d.FY.MissingPropertyOnSchemaForMemberProperty,node:e});return yield*(0,l.iC)(r,a,p,u,t)}case d.bG.MemberUserProperty:{const n=yield*je(e.expression,t);if("undefined"===n.type)return{type:"undefined"};if("person"!==n.type)throw new d.WV({type:d.FY.AccessingUserPropertyOnNonPerson,node:e,expressionValue:n});const r=(yield{recordPointers:[n.value]}).getRecordModel(n.value);if(void 0===r)throw new d.WV({type:d.FY.MissingDataDependencyPerson,node:e,personPointer:n.value});return(0,l.pp)(r,e.userProperty,t)}case d.bG.RecoveryNode:throw new d.WV({type:d.FY.UnexpectedRecoveryNode,recovery:e});default:(0,p.t1)(e)}}async function Ze(e,t,n){try{const n=je(e,t);let r=n.next();for(;!r.done;){const e=t.handleDataRequest(r.value);r=n.next((0,ke.tI)(e)?await e:e)}return{value:r.value}}catch(r){if(r instanceof d.WV){const e=r.info;return n&&(0,l.w7)(e)?{error:{...e,node:c(e.node,n)}}:{error:e}}return{error:{type:d.FY.UnexpectedError,error:(0,o.tg)(r)}}}}var Xe=n(21114);function*Je(e,t){switch(e.kind){case d.bG.Number:return{node:{...e,type:{type:"number"},context:t},errors:[]};case d.bG.String:return{node:{...e,type:{type:"text"},context:t},errors:[]};case d.bG.Boolean:return{node:{...e,type:{type:"checkbox"},context:t},errors:[]};case d.bG.NotionToken:{const o=e.token;switch(o.type){case l.Oy.Checkbox:return{node:{...e,type:{type:"checkbox"},context:t},errors:[]};case l.Oy.BlockProperty:{var n;const r=null===(n=t.valueTypes.find((e=>e.kind===l.yp.ThisRow)))||void 0===n?void 0:n.type;if(void 0===r)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:d.h4.ThisRowTypeNotFound,node:e}]};if("block"!==r.type||void 0===r.collection)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:d.h4.ThisRowNotBlockWithCollection,node:e}]};if(void 0===o.collection)return{node:{...e,type:l.dy[o.property],context:t},errors:[]};const a=(yield{recordPointers:[r.collection]}).getRecordModel(r.collection),i=null==a?void 0:a.getNormalizedSchema(),s=null==i?void 0:i[o.property];if(void 0===s||void 0===i)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:d.h4.MissingPropertyOnThisRow,node:e,token:o}]};const[p,u]=yield*(0,l.IP)(o.property,i,s);return{node:{...e,type:p,context:t},errors:!0===u?[{type:d.h4.MemberPropertyButtonType,node:e,token:o}]:[]}}case l.Oy.ContextValue:{var r;const n=null===(r=t.valueTypes.find((e=>e.kind===l.yp.ContextValue&&e.id===(0,l.Kv)(o.valueId))))||void 0===r?void 0:r.type;return void 0===n?{node:{...e,type:{type:"unknown"},context:t},errors:[{type:d.h4.MissingContextVariable,node:e,token:o}]}:{node:{...e,type:n,context:t},errors:[]}}case l.Oy.Block:{const n={table:Oe.iU,id:o.blockId,spaceId:o.spaceId},r=(yield{recordPointers:[n]}).getRecordModel(n);if(void 0===r)return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:d.h4.MissingBlock,node:e,token:o}]};const a=r.getCollectionPointer();return{node:{...e,type:{type:"block",collection:a},context:t},errors:[]}}case l.Oy.Person:return{node:{...e,type:{type:"person"},context:t},errors:[]};case l.Oy.UserProperty:return{node:{...e,type:{type:"unknown"},context:t},errors:[{type:d.h4.NonMemberUserProperty,node:e,token:o}]};case l.Oy.Date:return{node:{...e,type:{type:"date"},context:t},errors:[]};default:(0,p.t1)(o)}break}case d.bG.Array:{const n=yield*(0,l.LD)(e.elements.map((e=>Je(e,t))));let r={type:"unknown"};if(n.length>0){r=n[0].node.type;for(let e=1;e<n.length;e++)if(!(0,l.Jy)(r,n[e].node.type)){r={type:"unknown"};break}}return{node:{...e,elements:n.map((e=>e.node)),type:{type:"array",of:r},context:t},errors:n.flatMap((e=>e.errors))}}case d.bG.Identifier:{var o;const n=null===(o=t.valueTypes.find((t=>t.kind===l.yp.Binding&&t.id===e.text)))||void 0===o?void 0:o.type;if(void 0!==n)return{node:{...e,type:n,context:t},errors:[]};const r=qe[e.text];return void 0===r?{node:{...e,type:{type:"unknown"},context:t},errors:[{type:d.h4.UndefinedIdentifier,node:e}]}:{node:{...e,type:{type:"function",libraryFunction:r},context:t},errors:[]}}case d.bG.Conditional:{const n=yield*Je(e.condition,t),r=yield*Je(e.expIfTrue,t),o=void 0!==e.expIfFalse?yield*Je(e.expIfFalse,t):void 0;let a={type:"unknown"};return void 0===r.node.type||void 0!==(null==o?void 0:o.node.type)&&!(0,l.Jy)(r.node.type,o.node.type)||(a=r.node.type),{node:{...e,condition:n.node,expIfTrue:r.node,expIfFalse:null==o?void 0:o.node,type:a,context:t},errors:[...n.errors,...r.errors??[],...(null==o?void 0:o.errors)??[]]}}case d.bG.LogicalOr:case d.bG.LogicalAnd:case d.bG.Equality:case d.bG.Relational:{const n=yield*Je(e.lhs,t),r=yield*Je(e.rhs,t),o=[...n.errors,...r.errors];if(e.kind===d.bG.Relational){const t=n.node.type,a=r.node.type;"unknown"===t.type||"unknown"===a.type||t.type===a.type&&["number","date"].includes(t.type)||o.push({type:d.h4.CannotRelativelyCompareTypes,node:e,lhsType:t,rhsType:a})}return{node:{...e,lhs:n.node,rhs:r.node,type:{type:"checkbox"},context:t},errors:o}}case d.bG.Additive:case d.bG.Multiplicative:case d.bG.Exponentiation:{const n=yield*Je(e.lhs,t),r=yield*Je(e.rhs,t),o=[...n.errors,...r.errors];if("+"===e.op)return"number"===n.node.type.type&&"number"===r.node.type.type?{node:{...e,lhs:n.node,rhs:r.node,type:{type:"number"},context:t},errors:o}:{node:{...e,lhs:n.node,rhs:r.node,type:["unknown","number"].includes(n.node.type.type)&&["unknown","number"].includes(r.node.type.type??"unknown")?{type:"unknown"}:{type:"text"},context:t},errors:o};const a=function(e,t,n){const r=t.type,o=(null==n?void 0:n.type)??{type:"unknown"};if(!["unknown","number"].includes(r.type)||!["unknown","number"].includes(o.type))return{type:d.h4.CannotDoMathOnType,node:e,lhsType:r,rhsType:o}}(e,n.node,r.node);return void 0!==a&&o.push(a),{node:{...e,lhs:n.node,rhs:r.node,type:{type:"number"},context:t},errors:o}}case d.bG.Unary:{const n=yield*Je(e.expression,t),r=[...n.errors];let o;switch(e.op){case"-":["number","unknown"].includes(n.node.type.type)||r.push({type:d.h4.UnaryMinusOnNonNumber,node:e,expression:n.node}),o={type:"number"};break;case"!":case"not":o={type:"checkbox"};break;default:(0,p.t1)(e)}return{node:{...e,expression:n.node,type:o,context:t},errors:r}}case d.bG.Call:{const{node:n,errors:r}=yield*Je(e.expression,t),o=[...r];if(n.kind===d.bG.Identifier&&"let"===n.text){var a;const r=[];for(let n=0;n<e.arguments.length;n++){const a=e.arguments[n];if(0===n)r[0]={...a,type:{type:"unknown"},context:t};else if(1===n){const{node:e,errors:i}=yield*Je(a,t);r[n]=e,o.push(...i)}else if(2===n){var i,s;const p=(null===(i=e.arguments[0])||void 0===i?void 0:i.kind)===d.bG.Identifier?e.arguments[0].text:void 0,{node:u,errors:y}=yield*Je(a,void 0!==p?{...t,valueTypes:[{kind:l.yp.Binding,id:p,name:p,type:(null===(s=r[1])||void 0===s?void 0:s.type)??{type:"unknown"}},...t.valueTypes]}:t);r[n]=u,o.push(...y)}}return{node:{...e,expression:n,arguments:r,type:(null===(a=r[2])||void 0===a?void 0:a.type)??{type:"unknown"},context:t},errors:o}}["function","unknown"].includes(n.type.type)||o.push({type:d.h4.CallingNotFunction,node:e,callee:n});const p="function"===n.type.type?n.type.libraryFunction:void 0,u="function"===n.type.type?n.type.boundTargetType:void 0;if(void 0!==p){const t=(0,l.P2)(p),n=e.arguments.length+(void 0!==u?1:0);n<t&&o.push({type:d.h4.FunctionCallTooFewArguments,node:e,libraryFunction:p,numArguments:n,minNumParameters:t})}const y=[],c=[];void 0!==u&&c.push(u);for(let a=0;a<e.arguments.length;a++){const n=e.arguments[a],r=void 0!==u?a+1:a,i=void 0!==p?(0,l.J3)(p,r):void 0;if(void 0!==p&&void 0===i&&o.push({type:d.h4.FunctionCallUnexpectedArgument,node:e,libraryFunction:p,argument:n,parameterIndex:r}),void 0!==(null==i?void 0:i.augmentScope)){const e=y.map((e=>(null==e?void 0:e.type)??{type:"unknown"})),r=i.augmentScope(void 0!==u?[u,...e]:e),{node:s,errors:p}=yield*Je(n,{...t,valueTypes:[...Object.entries(r).map((e=>{let[t,n]=e;return{kind:l.yp.Binding,id:t,type:n}})),...t.valueTypes]});y[a]=s,c.push(s.type),o.push(...p)}else{const{node:r,errors:s}=yield*Je(n,t);if(y[a]=r,void 0!==p&&void 0!==i){const t=(0,l.xK)(r.type,i.type);"boolean"==typeof t?(c.push(r.type),t||o.push({type:d.h4.FunctionCallArgumentWrongType,node:e,libraryFunction:p,argument:r,expectedParameter:i})):c.push(t)}else c.push(r.type);o.push(...s)}}return{node:{...e,expression:n,arguments:y,type:void 0!==p?"function"==typeof p.returnType?p.returnType(c):p.returnType:{type:"unknown"},context:t},errors:o}}case d.bG.UnifiedFunctionProperty:{const n=qe[e.name],{node:r,errors:o}=yield*Je(e.expression,t),a=[...o];let i={type:"unknown"};if(void 0===n)a.push({type:d.h4.UnifiedFunctionCannotFindFunction,node:e,name:e.name});else{const t=(0,l.J3)(n,0);if(void 0===t)a.push({type:d.h4.UnifiedFunctionNoArguments,node:e,libraryFunction:n});else{const o=(0,l.xK)(r.type,t.type);"boolean"==typeof o?(i=r.type,o||a.push({type:d.h4.UnifiedFunctionTargetWrongType,node:e,expression:r,libraryFunction:n})):i=o}}return{node:{...e,expression:r,type:void 0!==n?{type:"function",boundTargetType:i,libraryFunction:n}:{type:"unknown"},context:t},errors:a}}case d.bG.MemberBlockProperty:{const{node:n,errors:r}=yield*Je(e.expression,t),o=[...r];let a;if("block"===n.type.type)if(void 0===e.propertyToken.collection)a=l.dy[e.propertyToken.property];else{const t=(yield{recordPointers:[e.propertyToken.collection]}).getRecordModel(e.propertyToken.collection),r=null==t?void 0:t.getNormalizedSchema(),i=null==r?void 0:r[e.propertyToken.property];if(void 0===i||void 0===r)o.push({type:d.h4.MemberPropertyMissing,node:e,token:e.propertyToken});else if(void 0!==n.type.collection)if((0,Te.qo)(e.propertyToken.collection,n.type.collection)){const t=yield*(0,l.IP)(e.propertyToken.property,r,i);a=t[0],!0===t[1]&&o.push({type:d.h4.MemberPropertyButtonType,node:e,token:e.propertyToken})}else o.push({type:d.h4.MemberPropertyMismatchCollection,node:e,token:e.propertyToken})}else"unknown"!==n.type.type&&o.push({type:d.h4.MemberPropertyTargetNotBlock,node:e,expression:n});return{node:{...e,expression:n,type:a??{type:"unknown"},context:t},errors:o}}case d.bG.MemberUserProperty:{const{node:n,errors:r}=yield*Je(e.expression,t),o=[...r];let a;return"person"===n.type.type?a=l.VJ[e.userProperty]:"unknown"!==n.type.type&&o.push({type:d.h4.MemberUserPropertyTargetNotPerson,node:e,expression:n}),{node:{...e,expression:n,type:a??{type:"unknown"},context:t},errors:o}}case d.bG.RecoveryNode:return{node:{...e,type:{type:"unknown"},context:t},errors:[]};default:(0,p.t1)(e)}}async function Ke(e,t,n){const r=Je(e,t);let o=r.next();for(;!o.done;){const e=t.handleDataRequest(o.value);o=r.next((0,ke.tI)(e)?await e:e)}if(!n)return o.value;const a=o.value.errors.map((e=>{const t=(0,Xe.sB)(e);return{...e,node:c(t,n)}}));return{node:o.value.node,errors:a}}var ze=n(31942);function Qe(e,t){if(t<e.startOffset||t>e.endOffset+1)return[];const n=e.kind;switch(n){case d.bG.Number:case d.bG.String:case d.bG.Boolean:case d.bG.NotionToken:case d.bG.Identifier:case d.bG.RecoveryNode:return[e];case d.bG.Conditional:{const n=Qe(e.condition,t);if(n.length>0)return[e,...n];const r=Qe(e.expIfTrue,t);if(r.length>0)return[e,...r];if(void 0!==e.expIfFalse){const n=Qe(e.expIfFalse,t);if(n.length>0)return[e,...n]}return[e]}case d.bG.LogicalOr:case d.bG.LogicalAnd:case d.bG.Equality:case d.bG.Relational:case d.bG.Additive:case d.bG.Multiplicative:case d.bG.Exponentiation:{const n=Qe(e.lhs,t);if(n.length>0)return[e,...n];const r=Qe(e.rhs,t);return r.length>0?[e,...r]:[e]}case d.bG.Array:for(const n of e.elements){const r=Qe(n,t);if(r.length>0)return[e,...r]}return[e];case d.bG.Unary:{const n=Qe(e.expression,t);return n.length>0?[e,...n]:[e]}case d.bG.Call:{const n=Qe(e.expression,t);if(n.length>0)return[e,...n];for(const r of e.arguments){const n=Qe(r,t);if(n.length>0)return[e,...n]}return[e]}case d.bG.UnifiedFunctionProperty:case d.bG.MemberBlockProperty:case d.bG.MemberUserProperty:{const n=Qe(e.expression,t);return n.length>0?[e,...n]:[e]}default:(0,p.t1)(n)}}async function He(e,t,n){const r=[];if(void 0!==e){const o=t.handleDataRequest({recordPointers:[e]}),a=((0,ke.tI)(o)?await o:o).getRecordModel(e),i=null==a?void 0:a.getNormalizedSchema();if(i)for(const[t,s]of Object.entries(i))"title"!==t&&null!=s&&s.name&&et(n,s.name)&&r.push({kind:l.WY.Token,name:s.name,token:{type:l.Oy.BlockProperty,property:(0,l.Uw)(t),collection:e}})}for(const o of Object.values(l.vz))(""===n||o.startsWith(n))&&r.push({kind:l.WY.Token,token:{type:l.Oy.BlockProperty,property:o,collection:void 0}});return r}function et(e,t){return""===e||(0,ze.C6)(e,t)}async function tt(e){const{prefix:t,context:n,receiverType:r,hideDeprecatedCompletions:o}=e,a=[],i=new Set;if(void 0===r){var s;n.valueTypes.forEach((e=>{if(e.kind===l.yp.Binding){const n=e.id;!i.has(n)&&et(t,e.id)&&(a.push({kind:l.WY.Binding,text:n,type:e.type}),i.add(n))}}));const e=null===(s=n.valueTypes.find((e=>e.kind===l.yp.ThisRow)))||void 0===s?void 0:s.type;"block"===(null==e?void 0:e.type)&&void 0!==e.collection&&a.push(...await He(e.collection,n,t)),n.valueTypes.forEach((e=>{if(e.kind===l.yp.ContextValue&&et(t,e.name)){const t=(0,l.ij)(e.id);a.push({kind:l.WY.Token,token:{type:l.Oy.ContextValue,valueId:t}})}}))}else"block"===r.type?a.push(...await He(r.collection,n,t)):"person"===r.type&&a.push(...function(e){const t=[];for(const n of Object.values(l.V2))(""===e||n.startsWith(e))&&t.push({kind:l.WY.Token,token:{type:l.Oy.UserProperty,userProperty:n}});return t}(t));for(const m in qe)if(!i.has(m)&&et(t,m)&&(!o||!m.startsWith("_"))){const e=qe[m];if(void 0!==r){var p,u,y,c,d,f;const t=(null===(p=e.parameters)||void 0===p||null===(u=p.expected)||void 0===u||null===(y=u[0])||void 0===y?void 0:y.type)??(null===(c=e.parameters)||void 0===c||null===(d=c.varargs)||void 0===d||null===(f=d[0])||void 0===f?void 0:f.type);if(void 0===t||!(0,l.qT)(r,t))continue}a.push({kind:l.WY.LibraryFunction,libraryFunction:e}),i.add(m)}return a}function nt(e,t){const n=[...e].reverse().find((e=>e.kind===d.bG.Call));if((null==n?void 0:n.kind)===d.bG.Call){let e=-1;if(t>n.lParenOffset&&(void 0===n.rParenOffset||t<=n.rParenOffset))for(e=0;e<n.commaOffsets.length&&!(n.commaOffsets[e]>t);e++);return{expression:n.expression,parameterIndex:e}}}async function rt(e){const{formula:t,inputPosition:n,context:o,hideDeprecatedCompletions:i}=e,[s,l]=y(t),u=function(e,t){if(0===t)return 0;let n=0,r=0;for(let o=0;o<e.length;o++){const a=e[o];switch(a.type){case"code":if(n+a.length>=t)return r+(t-n);n+=a.length,r+=a.length;break;case"token":if(n+1>=t)return r+a.length;n+=1,r+=a.length;break;default:(0,p.t1)(a)}}return r}(l,n);let c=s.substring(0,u);if(""===c.trim())return{value:{inputPosition:n,mappedPosition:u,completions:await tt({prefix:"",context:o,hideDeprecatedCompletions:i})}};const f=c[c.length-1],m=/[\s.]/.test(f);m&&(c=`${c}_`);const v=ue.tokenize(c).tokens;ce.input=v;const h=ge(ce.expression());if(r.x.isFail(h))return{value:void 0};const x=await Ke(h.value,o,l),{node:b}=x,g=v[v.length-1];let k=!1,T=v;void 0!==g&&(0,a.ol)(g,pe.IdentifierName)&&/\w/.test(c[c.length-1])&&(T=[...T],T.pop(),k=!0);const O=ce.computeContentAssist("expression",T),E=k?g.image.substring(0,g.image.length-(m?1:0)):void 0,w=Qe(b,u),U={inputPosition:n,mappedPosition:u,nodePath:w,callParameter:nt(w,u)};for(const r of O)if(r.nextTokenType===pe.IdentifierName)if("dotMemberExpression"===r.ruleStack[r.ruleStack.length-1]){const e=T[T.length-1];if(!(0,a.ol)(e,pe.Dot))return{value:void 0};const t=w[w.length-1];if(void 0!==t&&(t.kind===d.bG.UnifiedFunctionProperty||t.kind===d.bG.MemberBlockProperty)){const e=t.expression;U.completionsInfo={type:"member dot receiver",prefix:E,receiverNode:e},U.completions=await tt({prefix:E??"",context:e.context,receiverType:e.type,hideDeprecatedCompletions:i})}}else{var L;U.completionsInfo={type:"free identifier",prefix:E},U.completions=await tt({prefix:E??"",context:(null===(L=w[w.length-1])||void 0===L?void 0:L.context)??o,hideDeprecatedCompletions:i})}return{value:U}}var ot=n(91905);const at={join:"joinText",slice:"substring",start:"dateStart",end:"dateEnd"},it=["add","subtract","multiply","divide","pow","mod","and","or","equal","unequal","larger","largerEq","smaller","smallerEq"];function st(e,t,n){return r=e,o=pt(e,t,n),"conditional"===r.type||"function"===r.type&&(it.includes(r.name)||["unaryPlus","unaryMinus"].includes(r.name))||"operator"===r.type&&void 0!==r.args&&r.args.length>=2?[["("],...o,[")"]]:o;var r,o}function pt(e,t,n){switch(e.type){case"conditional":return[...st(e.condition,t,n),[" ? "],...st(e.true,t,n),[" : "],...st(e.false,t,n)];case"constant":switch(e.value_type){case"number":return(0,s.TP)(`${e.value}`);case"string":return(0,s.TP)(`"${e.value.replace(/"/g,'\\"')}"`);case"boolean":return(0,s.TP)(""+(e.value?"true":"false"));default:throw new Error(`unexpected constant type: ${e.value_type}`)}case"function":if(it.includes(e.name)){const r="equal"===e.name?"=":"concat"===e.name?"+":ot.Gn[e.name].operator;return[...st(e.args[0],t,n),[` ${r} `],...st(e.args[1],t,n)]}switch(e.name){case"unaryMinus":return[["-"],...st(e.args[0],t,n)];case"unaryPlus":return[["toNumber("],...pt(e.args[0],t,n),[")"]];case"month":return[["month("],...pt(e.args[0],t,n),[") - 1"]];case"day":return[["day("],...pt(e.args[0],t,n),[") % 7"]];case"concat":return[["("],...(0,Me.Z)((e.args??[]).map((e=>pt(e,t,n))),(()=>[[" + "]])).flat(),[")"]];default:if("id"===e.name)return(0,s.TP)("_idDeprecated()");const r=at[e.name]??e.name;if(void 0===qe[r])throw new Error(`unexpected formula: ${r}`);return[[`${r}(`],...(0,Me.Z)((e.args??[]).map((e=>pt(e,t,n))),(()=>[[", "]])).flat(),[")"]]}case"operator":var r,o;if(1===(null===(r=e.args)||void 0===r?void 0:r.length))switch(e.operator){case"not":return[["!"],...st(e.args[0],t,n)];case"+":return[["toNumber("],...pt(e.args[0],t,n),[")"]];default:return[[`${e.operator}`],...st(e.args[0],t,n)]}if(2===(null===(o=e.args)||void 0===o?void 0:o.length)){const r="=="===e.operator?"=":e.operator;return[...st(e.args[0],t,n),[` ${r} `],...st(e.args[1],t,n)]}switch(e.operator){case"?":return[...st(e.args[0],t,n),[" ? "],...st(e.args[0],t,n),[" : "],...st(e.args[0],t,n)];default:throw new Error(`unhandled operator: ${e.operator}`)}case"symbol":switch(e.name){case"pi":return(0,s.TP)("pi()");case"e":return(0,s.TP)("e()");default:throw new Error(`unexpected constant: ${e.name}`)}case"property":{const r=n[e.id];if(void 0===r)throw new Error(`missing property on schema ${e.id}`);const o=(0,s.YC)((0,s.kb)({collection:t,property:e.id}));switch(r.type){case"person":case"relation":return[["join(map("],o,[', _toPlainText(currentValue)), ", ")']];case"file":case"multi_select":return[["join("],o,[', ", ")']];default:return[o]}}case"error":throw new Error("unexpected formula error node")}}async function lt(e,t){const[n,o]=y(e),[a,i]=ve(n);if(i.length>0)return{error:i[0]};const s=ge(a);return r.x.isFail(s)?s:Ze(s.value,t)}async function ut(e,t){const[n]=y(e),[o,a]=ve(n);if(a.length>0)return{value:{parseErrors:a}};const i=ge(o);if(r.x.isFail(i))return{value:{parseErrors:[i.error]}};const s=await Ke(i.value,t),{node:p,errors:l}=s;return{value:{type:p.type,typeErrors:l}}}}}]);